# NGeoTrack 

The Basic Statistical Units (BSU), also referred to as Grunnkrets, are tthe most granular administrative units in the Norway. 
As of January 2022, there are a total of 14'100 such units. 

For anyone - who wants to compare administrative units over time or leverages their identification in a movers' designs - the tractability of the location identifier is of pivotal importance. 
However, (mainly) due to administrative re-organizations, these identifiers are subject to change. 

These functions are designed to ensure tractability, by assigning a stable identifier to each unit over time. We assign all identifiers to the smallest possible cluster (think LCD) that are consistent over the period defined by the user. 

***Important Note***:  The procedure is an extension to, and largely based on the following two repositories. In case you use these functions, make sure to cite the original authors. ~ 
[Norgeo](https://youtu.be/8bh238ekw3](https://github.com/helseprofil/norgeo)https://github.com/helseprofil/norgeo "@embed"), and [NoRwayGeo](https://github.com/eirikberger/NoRwayGeo "@NoRwayGeo") \
The official changes and lists of valid location codes are published by Statistics Norway ([SSB](https://www.ssb.no/klass/klassifikasjoner/1 "@SSB"))

 **Required packages**: [`dplyr`](https://dplyr.tidyverse.org/ "@dplyr"), [`httr2`](https://httr2.r-lib.org/ "@httr2"),[`igraph`](https://igraph.org/ "@igraph") and [`tidyr`](https://tidyr.tidyverse.org/ "@tidyr")

 
*An application of tractable clusters is described in the [Appendix](Appendix/Appendix.md)*


## Description 

Four functions are provided: 

1. [`gather_change()`](https://github.com/LaurinCurschellas/NGeoTrack/blob/main/gather_change.R "@GatherChange") 
Calls the API of Statistics Norway and gathers all the official changes reported to the selected administrative unit in the defined period. \
Syntax:
```R
data1 <- gather_change(type = "grunnkrets" , from = 1990 , to = 2022)
```
The function is applicable to BSU ("grunnkrets") and municipalities ("kommune"). \ The current release of [SSB](@SSB) supports data for the years 1980-2023 and 1950-2023 for BSU and municipalities respectively. 

2. [`status_quo()`](https://github.com/LaurinCurschellas/NGeoTrack/blob/main/Status_quo_type.R "@StatusQuo") 
Calls the API and gathers all the valid codes for the full panel of the specified time period.
```R
data2 <- status_quo(type = "grunnkrets" , from = 1990 , to = 2022) 
```
3. [`EtE_changes()`](https://github.com/LaurinCurschellas/NGeoTrack/blob/main/EtE_Change.R "@EtEChanges") 
**This is the core function**: It generates tractable clusters, and provides a key assigning allowing to assign all observations to their respective cluster. The input for this function is the datasets generated by the above functions.
```R
EtE_changes(df_status = data2 , df_change = data1 , from = 1990 , to = 2022, jointly = FALSE) 
```
3.1  
Joint harmonization of BSU and Municipality identifiers: 
The changes and status quo data sets have to be generated for each type individually, and supplied as a list to `EtE_changes()` - the harmonizing function. 
```R
changes_list <- list(changes_bsu, changes_mun) # The order in list is not relevant. 
status_list <- list(status_bsu, status_mun)

EtE_changes(df_status = status_list , df_change = changes_list , from = 1990 , to = 2022, jointly = TRUE) 
```

4. [`check_overlap()`](https://github.com/LaurinCurschellas/NGeoTrack/blob/main/R/check_overlap.R "@Overlap") 
This function analyses the generated key and returns information on BSU-clusters that overlap the borders of municipality clusters. 
```R
overlap <- check_overlap(df_key) # Prints an overview to the console, summarising the detailed output
# Vector of affected Grunnkrets Clusters
head(overlap$candidates)
[1] 100124 100125 102230 100016 100373
# Dataframe of municipality details
head(overlap$details)
# A tibble: 5 × 5
  Gcluster_id Ccluster_id_1 Ccluster_id_2 Cname_1     Cname_2          
        <int>         <int>         <int> <chr>       <chr>            
1      100124           528           529 Østre Toten Vestre Toten     
2      100125           528           529 Østre Toten Vestre Toten     
3      102230          1444          1449 Hornindal   Stryn            
4      100016          1911        500023 Kvæfjord    Sortland - Suortá
5      100373           704        500016 Tønsberg    Sandefjord  
```


## Output 

### Official Changes 

A data frame containing all the official reported changes in the period specified by the user
```R
head(df_change, 5)
        from              oldName       to              newName     year
# 1: 02191601 Slependen - Tanum 18   02191618 Slependen - Tanum 18   1991
# 2: 02191601 Slependen - Tanum 18   02191619 Slependen - Tanum 19   1991
# 3: 02191601 Slependen - Tanum 18   02191620 Slependen - Tanum 20   1991
# 4: 02192104       Bærums verk 17   02192117       Bærums verk 17   1991
# 5: 02192104       Bærums verk 17   02192118       Bærums verk 18   1991
````
The year column indicates the year in which the change took effect. 

### Status Quo 

A data frame containing a full panel of the official location codes in a given year

```R
head(df_status, 5)
# A tibble: 10 × 4
       geoID name                 from    to
       <int> <chr>               <int> <int>
# 1 1010101 Karrestad            1990  1991
# 2 1010102 Båstadlund           1990  1991
# 3 1010103 Låby                 1990  1991
# 4 1010104 Stangeløkka          1990  1991
# 5 1010105 Refne - Banken       1990  1991
```
The from and to columns indicate the period for which these codes were officially in effect.

### The Key

This is the main object of interest to the user. The key will act as a data frame that can be merged to a population registry (by year and location ID) assigning each observation a Cluster-ID which is ensured to be tractable 
over the time period specified when generating the data set. 

```R
head(df_key, 5) 
# A tibble: 10 × 4
       geoID name                cluster_id  year
       <int> <chr>                    <int> <int>
 # 1 1010101 Karrestad               100716  1990
 # 2 1010102 Båstadlund              100714  1990
 # 3 1010103 Låby                    100715  1990
 # 4 1010104 Stangeløkka             100715  1990
 # 5 1010105 Refne - Banken          100715  1990
```


